# Context
Filename: task.md
Created On: 2025-11-20
Created By: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
Implement a Map/Stage system to diversify gameplay visuals and difficulty.
- **Stage System**: Progression based on time.
- **Visuals**: Each stage has distinct background and grid colors.
- **Enemies**: Different stages spawn different enemy combinations/variants.
- **Stages**:
    1. **Dark Forest (幽暗密林)**: Default.
    2. **Bone Wasteland (埋骨之地)**: Grey theme.
    3. **Magma Core (熔岩炼狱)**: Red theme.
    4. **Frozen Tundra (极寒冰原)**: Blue theme.

# Project Overview
Lingjian Game. Currently single infinite stage.

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
- **Current Logic**: `Game.playTime` drives difficulty. Background is hardcoded.
- **Refactoring Needs**:
    - `GameEngine` needs `currentStage` index.
    - `STAGES` config array.
    - `draw()` needs to read colors from config.
    - `spawnEnemy()` needs to read spawn weights/types from config.

# Proposed Solution (Populated by INNOVATE mode)
- **Configuration**:
    ```javascript
    const STAGES = [
        { name: '幽暗密林', time: 0, bg: '#0f1519', grid: '#1c262b', mobs: ['bat'] },
        { name: '埋骨之地', time: 60, bg: '#202020', grid: '#333333', mobs: ['bat', 'ghost'] },
        { name: '熔岩炼狱', time: 120, bg: '#1a0505', grid: '#3d0e0e', mobs: ['fire_bat', 'rock'] },
        { name: '极寒冰原', time: 180, bg: '#050a1a', grid: '#0e1e3d', mobs: ['ice_ghost', 'rock'] }
    ];
    ```
- **Enemy Variants**:
    - `fire_bat`: Red bat, higher speed?
    - `ice_ghost`: Blue ghost, slows player? (Maybe too complex, just visual first + stats).
    - Update `Enemy` constructor to handle these new types or map them to base types with overrides.

# Implementation Plan (Generated by PLAN mode)
Implementation Checklist:
1.  [x] Update `SVG_LIB`: Add `bat_fire` (red) and `ghost_ice` (blue).
2.  [x] Define `STAGES` constant array.
3.  [x] Update `GameEngine`:
    - Add `stageIdx` state.
    - Add `checkStage()` logic in `update`.
    - Update `draw()` to use stage colors.
    - Update `spawnEnemy()` to use stage mobs.
    - Add "Stage Enter" text effect.
4.  [x] Update `Enemy` class to handle `fire_bat` and `ice_ghost` stats.

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> Currently executing: "Final Review"

# Task Progress (Appended by EXECUTE mode after each step completion)
*   2025-11-20
    *   Step: 1-4
    *   Modifications: Implemented Map/Stage system with 5 stages and new enemy variants.
    *   Change Summary: Added multi-stage progression with visual changes and difficulty scaling.
    *   Reason: Executing plan.
    *   Blockers: None.
    *   User Confirmation Status: Pending Confirmation
