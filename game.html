<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>çµå‰‘ â€¢ ç»ä¸–ä»™ç¼˜ (V5.0 ä¸‡æ³•å½’ä¸€ç‰¹æ•ˆç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

        body {
            margin: 0; overflow: hidden; background-color: #050505;
            font-family: 'Ma Shan Zheng', 'KaiTi', serif;
            user-select: none; color: #fff;
        }
        canvas { display: block; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
        }
        
        /* é¡¶éƒ¨HUD */
        .hud-top { padding: 20px; display: flex; align-items: flex-start; gap: 20px; }
        .avatar-frame {
            width: 80px; height: 80px; border-radius: 50%;
            border: 3px solid #f1c40f; box-shadow: 0 0 15px #f1c40f;
            background: #222; overflow: hidden; position: relative;
        }
        .avatar-frame img { width: 100%; height: 100%; object-fit: cover; }
        
        .bars { flex: 1; max-width: 400px; display: flex; flex-direction: column; gap: 8px; }
        .bar-wrap { height: 16px; background: rgba(0,0,0,0.6); border: 1px solid #444; border-radius: 8px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; transition: width 0.2s ease-out; }
        #hp-bar { background: linear-gradient(90deg, #c0392b, #e74c3c); width: 100%; }
        #exp-bar { background: linear-gradient(90deg, #8e44ad, #9b59b6); width: 0%; }
        .bar-text { position: absolute; top: 0; left: 10px; font-size: 12px; line-height: 16px; text-shadow: 1px 1px 2px black; }

        .score-board { position: absolute; top: 20px; right: 30px; text-align: right; }
        .big-text { font-size: 32px; color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }

        /* èœå•é®ç½© */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 99; pointer-events: auto; transition: opacity 0.3s;
        }
        .hidden { opacity: 0 !important; pointer-events: none !important; }
        
        .menu-box { text-align: center; animation: float 3s ease-in-out infinite; }
        .game-title {
            font-size: 80px;
            background: linear-gradient(to bottom, #fff, #bdc3c7);
            -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 30px rgba(255,255,255,0.3); margin-bottom: 20px;
        }
        
        /* å¡ç‰‡ç³»ç»Ÿ */
        .card-container { display: flex; gap: 30px; perspective: 1000px; }
        .card {
            width: 220px; height: 320px;
            background: linear-gradient(160deg, #2c3e50, #000);
            border: 2px solid #d4af37; border-radius: 12px;
            padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2); transition: transform 0.3s;
        }
        .card:hover { transform: translateY(-20px) scale(1.05); box-shadow: 0 0 50px rgba(212, 175, 55, 0.6); border-color: #fff; }
        .card-icon { font-size: 60px; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.5)); }
        .card h3 { color: #f1c40f; margin: 0 0 10px 0; font-size: 24px; }
        .card p { color: #bdc3c7; font-size: 14px; line-height: 1.6; }
        /* ç¨€æœ‰åº¦è¾¹æ¡†é¢œè‰² */
        .rare-fire { border-color: #e74c3c; box-shadow: 0 0 20px #c0392b; }
        .rare-thunder { border-color: #f1c40f; box-shadow: 0 0 20px #f39c12; }
        .rare-wood { border-color: #2ecc71; box-shadow: 0 0 20px #27ae60; }
        .rare-water { border-color: #3498db; box-shadow: 0 0 20px #2980b9; }
        .rare-earth { border-color: #e67e22; box-shadow: 0 0 20px #d35400; }

        .btn {
            padding: 15px 50px; font-size: 24px; color: white;
            background: linear-gradient(45deg, #c0392b, #8e44ad);
            border: none; border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(192, 57, 43, 0.4); font-family: inherit;
        }
        .btn:hover { transform: scale(1.1); filter: brightness(1.2); }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
    </style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer">
    <div class="hud-top">
        <div class="avatar-frame" id="avatar-container"></div>
        <div class="bars">
            <div style="font-size: 20px; color: #f1c40f; text-shadow: 0 0 5px #000;">
                <span id="rank-name">ç»ƒæ°”æœŸ</span> <span id="rank-lvl">1å±‚</span>
            </div>
            <div class="bar-wrap"><div id="hp-bar" class="bar-fill"></div><div class="bar-text">æ°”è¡€</div></div>
            <div class="bar-wrap"><div id="exp-bar" class="bar-fill"></div><div class="bar-text">ä¿®ä¸º</div></div>
        </div>
        <div class="score-board">
            <div class="big-text" id="timer">00:00</div>
            <div style="color:#aaa;">æ–©å¦–: <span id="kills">0</span></div>
        </div>
    </div>
</div>

<div id="overlay">
    <div id="start-menu" class="menu-box">
        <div class="game-title">çµå‰‘ â€¢ ç»ä¸–ä»™ç¼˜</div>
        <p style="color: #aaa; margin-bottom: 40px;">ä¸‡æ³•å½’ä¸€ â€¢ ç‰¹æ•ˆå‡çº§ç‰ˆ</p>
        <button class="btn" onclick="Game.start()">å¼€å®—ç«‹æ´¾</button>
    </div>
    <div id="levelup-menu" class="menu-box hidden">
        <h2 style="color:#f1c40f; font-size:40px; margin-bottom:30px; text-shadow:0 0 20px #f1c40f;">é¡¿æ‚Ÿæœºç¼˜</h2>
        <div class="card-container" id="card-container"></div>
    </div>
    <div id="gameover-menu" class="menu-box hidden">
        <h1 style="color:#c0392b; font-size:60px;">é“æ¶ˆèº«æ®’</h1>
        <p id="final-score" style="font-size:24px; color:#eee; margin-bottom:30px;"></p>
        <button class="btn" onclick="location.reload()">é‡å…¥è½®å›</button>
    </div>
</div>

<script>
/**
 * çµå‰‘ â€¢ V5.0 å¼•æ“æ ¸å¿ƒ
 * åŒ…å«ï¼šå¤šå…ƒç´ å­å¼¹ç³»ç»Ÿã€å±å¹•éœ‡åŠ¨ã€ç²’å­çˆ†ç‚¸
 */

// --- 1. çŸ¢é‡ç´ æåº“ (æ–°å¢ç«ç„°ã€é—ªç”µ) ---
const SVG_LIB = {
    player: `<svg width="128" height="128" viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg"><defs><filter id="g"><feGaussianBlur stdDeviation="2"/></filter></defs><ellipse cx="64" cy="110" rx="30" ry="10" fill="rgba(0,0,0,0.5)"/><path d="M30 80 Q10 90 20 110" stroke="#3498db" stroke-width="4" fill="none"/><path d="M98 80 Q118 90 108 110" stroke="#3498db" stroke-width="4" fill="none"/><path d="M44 70 Q64 120 84 70 L 84 50 L 44 50 Z" fill="#ecf0f1"/><rect x="44" y="50" width="40" height="30" fill="#ecf0f1"/><path d="M44 50 L44 100 L64 90 L84 100 L84 50" fill="none" stroke="#2c3e50" stroke-width="2"/><path d="M64 50 L64 100" stroke="#3498db" stroke-width="4"/><circle cx="64" cy="40" r="22" fill="#ffe0b2"/><path d="M40 30 Q64 10 88 30 Q90 50 86 60 Q64 65 42 60 Q38 50 40 30" fill="#2c3e50"/><circle cx="64" cy="15" r="10" fill="#2c3e50"/><rect x="59" y="10" width="10" height="5" fill="#f1c40f"/><circle cx="56" cy="42" r="2" fill="#000"/><circle cx="72" cy="42" r="2" fill="#000"/></svg>`,
    
    // 1. é’äº‘å‰‘ (åŸºç¡€)
    sword: `<svg width="64" height="128" viewBox="0 0 64 128" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="sg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0" stop-color="#fff"/><stop offset="1" stop-color="#00bcd4"/></linearGradient></defs><path d="M32 0 L22 20 L28 100 L36 100 L42 20 Z" fill="url(#sg)"/><rect x="20" y="90" width="24" height="6" fill="#f1c40f"/><circle cx="32" cy="110" r="4" fill="#f1c40f"/></svg>`,
    
    // 2. çº¢è²ä¸šç« (ç«çƒ)
    fire: `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><radialGradient id="fg"><stop offset="0%" stop-color="#ffff00"/><stop offset="50%" stop-color="#ff5722"/><stop offset="100%" stop-color="rgba(255,0,0,0)"/></radialGradient></defs><circle cx="32" cy="32" r="28" fill="url(#fg)"/><path d="M32 60 Q10 40 32 10 Q54 40 32 60" fill="#ff9800" opacity="0.7"/></svg>`,
    
    // 3. ä¹å¤©ç¥é›· (é—ªç”µ)
    thunder: `<svg width="40" height="100" viewBox="0 0 40 100" xmlns="http://www.w3.org/2000/svg"><path d="M20 0 L0 40 L15 40 L5 100 L35 50 L20 50 L40 10 Z" fill="#fff" stroke="#ffeb3b" stroke-width="2" stroke-linejoin="round"/></svg>`,

    // 4. äº”è¡Œæ–°å…ƒç´ 
    leaf: `<svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M24 46 Q4 30 4 14 Q4 2 24 2 Q44 2 44 14 Q44 30 24 46 M24 2 L24 46" fill="#2ecc71" stroke="#27ae60" stroke-width="2"/></svg>`,
    ice: `<svg width="48" height="48" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M24 0 L30 18 L48 24 L30 30 L24 48 L18 30 L0 24 L18 18 Z" fill="#e1f5fe" stroke="#03a9f4" stroke-width="2"/></svg>`,
    // Earth uses 'rock' which is already in Enemy assets, but we might want a cleaner one for Bullet
    rock_b: `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M10 30 L5 20 L15 5 L30 8 L35 25 L25 35 Z" fill="#795548" stroke="#5d4037" stroke-width="2"/></svg>`,

    // æ€ªç‰©
    bat: `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 40 Q60 10 60 30 L32 50 L4 30 Q4 10 32 40" fill="#c0392b"/><circle cx="25" cy="35" r="2" fill="#ffeb3b"/><circle cx="39" cy="35" r="2" fill="#ffeb3b"/></svg>`,
    bat_fire: `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><path d="M32 40 Q60 10 60 30 L32 50 L4 30 Q4 10 32 40" fill="#ff5722"/><circle cx="25" cy="35" r="2" fill="#ffeb3b"/><circle cx="39" cy="35" r="2" fill="#ffeb3b"/></svg>`,
    ghost: `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="30" r="20" fill="#009688" opacity="0.6"/><path d="M12 30 Q32 60 52 30" fill="none" stroke="#004d40" stroke-width="2"/><circle cx="25" cy="25" r="3" fill="#000"/><circle cx="39" cy="25" r="3" fill="#000"/></svg>`,
    ghost_ice: `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="30" r="20" fill="#03a9f4" opacity="0.6"/><path d="M12 30 Q32 60 52 30" fill="none" stroke="#0277bd" stroke-width="2"/><circle cx="25" cy="25" r="3" fill="#000"/><circle cx="39" cy="25" r="3" fill="#000"/></svg>`,
    rock: `<svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M20 60 L10 40 L30 10 L60 15 L70 50 L50 70 Z" fill="#5d4037"/><rect x="25" y="35" width="10" height="10" fill="#ff5722"/></svg>`
};

const STAGES = [
    { name: 'å¹½æš—å¯†æ—', time: 0, bg: '#0f1519', grid: '#1c262b', mobs: ['bat'] },
    { name: 'åŸ‹éª¨ä¹‹åœ°', time: 60, bg: '#202020', grid: '#333333', mobs: ['bat', 'ghost'] },
    { name: 'ç†”å²©ç‚¼ç‹±', time: 120, bg: '#1a0505', grid: '#3d0e0e', mobs: ['bat_fire', 'rock'] },
    { name: 'æå¯’å†°åŸ', time: 180, bg: '#050a1a', grid: '#0e1e3d', mobs: ['ghost_ice', 'rock'] },
    { name: 'å¤©å¤–è™šç©º', time: 300, bg: '#000000', grid: '#222', mobs: ['bat_fire', 'ghost_ice', 'rock'] }
];

const Assets = {};
function loadAssets() {
    for (let key in SVG_LIB) {
        const img = new Image();
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(SVG_LIB[key])));
        Assets[key] = img;
    }
    setTimeout(() => document.getElementById('avatar-container').appendChild(Assets['player'].cloneNode()), 100);
}

// --- 2. æ¸¸æˆå¼•æ“ ---

class GameEngine {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.state = 'MENU';
        this.lastTime = 0;
        this.playTime = 0;
        this.score = 0;
        this.stageIdx = 0;
        this.player = null;
        this.enemies = []; this.bullets = []; this.particles = []; this.orbs = []; this.texts = [];
        this.camera = { x: 0, y: 0 };
        this.shake = 0; // å±å¹•éœ‡åŠ¨å€¼
        this.keys = {};
        
        window.addEventListener('resize', () => this.resize());
        window.addEventListener('keydown', e => this.keys[e.code] = true);
        window.addEventListener('keyup', e => this.keys[e.code] = false);
        this.resize();
        loadAssets();
        requestAnimationFrame(t => this.loop(t));
    }
    
    resize() { this.width=this.canvas.width=window.innerWidth; this.height=this.canvas.height=window.innerHeight; }
    
    start() {
        this.player = new Player();
        this.enemies=[]; this.bullets=[]; this.particles=[]; this.orbs=[]; this.texts=[];
        this.score=0; this.playTime=0; this.stageIdx=0; this.state='PLAY';
        document.getElementById('overlay').classList.add('hidden');
        document.getElementById('start-menu').classList.add('hidden');
        document.getElementById('gameover-menu').classList.add('hidden');
        this.updateUI();
        this.showStageTitle(STAGES[0].name);
    }
    
    loop(now) {
        const dt = Math.min((now - this.lastTime) / 1000, 0.1);
        this.lastTime = now;
        if (this.state === 'PLAY') { this.update(dt); this.draw(); }
        requestAnimationFrame(t => this.loop(t));
    }
    
    update(dt) {
        this.playTime += dt;
        if(this.shake > 0) this.shake -= dt * 10;
        
        // å…³å¡æ£€æµ‹
        const nextStage = STAGES[this.stageIdx + 1];
        if (nextStage && this.playTime >= nextStage.time) {
            this.stageIdx++;
            this.showStageTitle(STAGES[this.stageIdx].name);
            // è¿›é˜¶å›è¡€
            this.player.hp = Math.min(this.player.hp + 20, this.player.maxHp);
            this.updateUI();
        }

        // åˆ·æ€ª
        const diff = 1 + this.playTime/60;
        if(Math.random() < dt / (1.5/diff)) this.spawnEnemy(diff);
        
        this.player.update(dt);
        
        // ç›¸æœºè·Ÿéš + éœ‡åŠ¨
        let tx = this.player.x - this.width/2;
        let ty = this.player.y - this.height/2;
        this.camera.x += (tx - this.camera.x) * 5 * dt;
        this.camera.y += (ty - this.camera.y) * 5 * dt;
        
        this.enemies.forEach(e => e.update(dt, this.player));
        this.bullets.forEach(b => b.update(dt));
        this.particles.forEach(p => p.update(dt));
        this.orbs.forEach(o => o.update(dt, this.player));
        this.texts.forEach(t => t.update(dt));
        
        // æ¸…ç†
        this.enemies = this.enemies.filter(e => !e.dead);
        this.bullets = this.bullets.filter(b => !b.dead);
        this.particles = this.particles.filter(p => !p.dead);
        this.orbs = this.orbs.filter(o => !o.dead);
        this.texts = this.texts.filter(t => !t.dead);
        
        document.getElementById('timer').innerText = this.formatTime(this.playTime);
    }
    
    draw() {
        const ctx = this.ctx;
        const stage = STAGES[this.stageIdx];

        // èƒŒæ™¯
        ctx.fillStyle = stage.bg;
        ctx.fillRect(0, 0, this.width, this.height);
        
        ctx.save();
        // åº”ç”¨ç›¸æœºéœ‡åŠ¨
        let sx = (Math.random() - 0.5) * this.shake * 10;
        let sy = (Math.random() - 0.5) * this.shake * 10;
        ctx.translate(-this.camera.x + sx, -this.camera.y + sy);
        
        // ç½‘æ ¼
        ctx.strokeStyle = stage.grid; ctx.lineWidth = 2;
        const G = 100;
        const sx_grid = Math.floor(this.camera.x/G)*G;
        const sy_grid = Math.floor(this.camera.y/G)*G;
        ctx.beginPath();
        for(let x=sx_grid; x<this.camera.x+this.width; x+=G) { ctx.moveTo(x, this.camera.y); ctx.lineTo(x, this.camera.y+this.height); }
        for(let y=sy_grid; y<this.camera.y+this.height; y+=G) { ctx.moveTo(this.camera.x, y); ctx.lineTo(this.camera.x+this.width, y); }
        ctx.stroke();
        
        this.orbs.forEach(o => o.draw(ctx));
        this.enemies.forEach(e => e.draw(ctx));
        this.player.draw(ctx);
        
        // å åŠ æ¨¡å¼è®©ç‰¹æ•ˆæ›´äº®
        ctx.globalCompositeOperation = 'lighter';
        this.bullets.forEach(b => b.draw(ctx));
        this.particles.forEach(p => p.draw(ctx));
        ctx.globalCompositeOperation = 'source-over';
        
        this.texts.forEach(t => t.draw(ctx));
        ctx.restore();
    }
    
    spawnEnemy(diff) {
        const a = Math.random() * Math.PI * 2;
        const r = Math.max(this.width, this.height)/2 + 100;
        const x = this.player.x + Math.cos(a)*r;
        const y = this.player.y + Math.sin(a)*r;
        
        const stage = STAGES[this.stageIdx];
        const type = stage.mobs[Math.floor(Math.random() * stage.mobs.length)];
        
        this.enemies.push(new Enemy(type, x, y, diff));
    }
    
    formatTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${Math.floor(s%60).toString().padStart(2,'0')}`; }
    
    showStageTitle(text) {
        // ç®€å•å®ç°ï¼šåˆ›å»ºä¸€ä¸ªå¤§çš„æµ®åŠ¨æ–‡å­—æˆ–è€…ä½¿ç”¨DOM
        const d = document.createElement('div');
        d.style.position = 'absolute'; d.style.top='30%'; d.style.left='50%'; d.style.transform='translate(-50%, -50%)';
        d.style.fontSize = '60px'; d.style.color = '#f1c40f'; d.style.textShadow = '0 0 20px black';
        d.style.pointerEvents = 'none'; d.style.animation = 'float 3s ease-out';
        d.innerText = `è¿›å…¥åŒºåŸŸ: ${text}`;
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 3000);
    }

    updateUI() {
        const p = this.player;
        document.getElementById('hp-bar').style.width = (p.hp/p.maxHp*100)+'%';
        document.getElementById('exp-bar').style.width = (p.exp/p.maxExp*100)+'%';
        document.getElementById('kills').innerText = this.score;
        const r = ['ç»ƒæ°”','ç­‘åŸº','é‡‘ä¸¹','å…ƒå©´','åŒ–ç¥','æ¸¡åŠ«'];
        document.getElementById('rank-name').innerText = r[Math.min(Math.floor((p.lvl-1)/3), r.length-1)];
        document.getElementById('rank-lvl').innerText = ((p.lvl-1)%3 + 1) + 'å±‚';
    }
    
    pause() { this.state = 'PAUSE'; document.getElementById('overlay').classList.remove('hidden'); }
    resume() { this.state = 'PLAY'; document.getElementById('overlay').classList.add('hidden'); this.lastTime=performance.now(); }
    gameOver() { this.state = 'OVER'; document.getElementById('final-score').innerText=`å­˜æ´»: ${this.formatTime(this.playTime)} | å‡»æ€: ${this.score}`; document.getElementById('overlay').classList.remove('hidden'); document.getElementById('gameover-menu').classList.remove('hidden'); }
    
    screenShake(amount) { this.shake = amount; }
}

// --- 3. å®ä½“ç±» ---

class Entity { constructor(x,y) { this.x=x; this.y=y; this.dead=false; } dist(o){ return Math.hypot(this.x-o.x, this.y-o.y); } }

class Player extends Entity {
    constructor() {
        super(0,0);
        this.hp=100; this.maxHp=100; this.speed=250;
        this.exp=0; this.maxExp=10; this.lvl=1;
        // statsåŒ…å« element: 'sword'|'fire'|'thunder'|'wood'|'water'|'earth'
        this.stats = { dmg:20, area:150, count:1, cd:0.8, spd:500, element:'sword', pierce:0 }; 
        this.cdTimer=0; this.facing=1; this.lvlUpFx=0;
    }
    update(dt) {
        let dx=0, dy=0;
        if(Game.keys['KeyW']||Game.keys['ArrowUp']) dy=-1;
        if(Game.keys['KeyS']||Game.keys['ArrowDown']) dy=1;
        if(Game.keys['KeyA']||Game.keys['ArrowLeft']) dx=-1;
        if(Game.keys['KeyD']||Game.keys['ArrowRight']) dx=1;
        if(dx||dy) {
            const l = Math.hypot(dx,dy);
            this.x += (dx/l)*this.speed*dt; this.y += (dy/l)*this.speed*dt;
            if(dx) this.facing = dx;
        }
        this.cdTimer-=dt;
        if(this.cdTimer<=0) {
            const t = this.findTarget();
            if(t) { this.fire(t); this.cdTimer = this.stats.cd; }
        }
    }
    findTarget() {
        let near=null, minD=600;
        for(let e of Game.enemies) { const d=this.dist(e); if(d<minD){minD=d; near=e;} }
        return near;
    }
    fire(t) {
        for(let i=0; i<this.stats.count; i++) {
            setTimeout(() => {
                if (this.stats.element === 'thunder') {
                    if (t.dead) return;
                    Game.particles.push(new Lightning(this.x, this.y, t.x, t.y));
                    const a = Math.atan2(t.y - this.y, t.x - this.x);
                    t.takeDamage(this.stats.dmg, Math.cos(a), Math.sin(a), 'thunder');
                    for(let k=0; k<5; k++) Game.particles.push(new Particle(t.x, t.y, '#ffeb3b', 0.3, 4));
                } else {
                    Game.bullets.push(new Bullet(this.x, this.y, t, this.stats));
                }
            }, i * (this.stats.element === 'thunder' ? 50 : 100)); 
        }
    }
    draw(ctx) {
        const t = Game.playTime;
        ctx.save(); ctx.translate(this.x, this.y);
        let auraColor = '#f1c40f';
        if(this.stats.element === 'fire') auraColor = '#e74c3c';
        if(this.stats.element === 'thunder') auraColor = '#8e44ad';
        if(this.stats.element === 'wood') auraColor = '#2ecc71';
        if(this.stats.element === 'water') auraColor = '#3498db';
        if(this.stats.element === 'earth') auraColor = '#e67e22';
        
        ctx.rotate(t*0.5);
        ctx.beginPath(); ctx.arc(0,0,45,0,Math.PI*2);
        ctx.strokeStyle = auraColor; ctx.globalAlpha=0.3; ctx.lineWidth=2; ctx.setLineDash([15,25]); ctx.stroke();
        ctx.restore();
        
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.scale(this.facing, 1);
        ctx.drawImage(Assets['player'], -32, -32, 64, 64);
        ctx.restore();
        
        if(this.lvlUpFx>0) {
            this.lvlUpFx-=0.05;
            ctx.beginPath(); ctx.arc(this.x,this.y, 40+(1-this.lvlUpFx)*150, 0, Math.PI*2);
            ctx.strokeStyle = `rgba(255,255,255,${this.lvlUpFx})`; ctx.lineWidth=5; ctx.stroke();
        }
    }
    gainExp(v){ this.exp+=v; if(this.exp>=this.maxExp) this.levelUp(); Game.updateUI(); }
    levelUp(){ this.lvl++; this.exp=0; this.maxExp=Math.floor(this.maxExp*1.4); this.hp=this.maxHp; this.lvlUpFx=1.0; showUpgradeMenu(); }
    hit(d){ this.hp-=d; Game.texts.push(new FloatText(this.x,this.y,"-"+Math.floor(d),'#e74c3c')); Game.updateUI(); if(this.hp<=0) Game.gameOver(); }
}

class Enemy extends Entity {
    constructor(type,x,y,diff) {
        super(x,y); this.type=type;
        if(type==='bat'){ this.hp=20*diff; this.speed=150; this.dmg=5; this.exp=5; this.img='bat'; }
        else if(type==='bat_fire'){ this.hp=30*diff; this.speed=180; this.dmg=8; this.exp=8; this.img='bat_fire'; }
        else if(type==='ghost'){ this.hp=40*diff; this.speed=100; this.dmg=10; this.exp=10; this.img='ghost'; }
        else if(type==='ghost_ice'){ this.hp=50*diff; this.speed=90; this.dmg=12; this.exp=15; this.img='ghost_ice'; }
        else { this.hp=100*diff; this.speed=60; this.dmg=20; this.exp=25; this.img='rock'; }
        this.maxHp=this.hp; this.pushX=0; this.pushY=0;
        this.slowTimer = 0;
    }
    update(dt,p) {
        if(this.slowTimer>0) this.slowTimer-=dt;
        let spd = this.speed;
        if(this.slowTimer>0) spd *= 0.5; // å‡é€Ÿ50%

        const a = Math.atan2(p.y-this.y, p.x-this.x);
        this.x += (Math.cos(a)*spd+this.pushX)*dt;
        this.y += (Math.sin(a)*spd+this.pushY)*dt;
        this.pushX*=0.9; this.pushY*=0.9;
        if(this.dist(p)<30) p.hit(this.dmg*dt);
    }
    takeDamage(v, kx, ky, type) {
        this.hp-=v; 
        let force = 120;
        if(type === 'earth') force = 300; // åœŸç³»å¼ºå‡»é€€
        this.pushX=kx*force; this.pushY=ky*force;
        
        let c = '#fff';
        if(type === 'fire') c = '#ff5722';
        if(type === 'thunder') c = '#ffeb3b';
        if(type === 'wood') c = '#2ecc71';
        if(type === 'water') c = '#3498db';
        if(type === 'earth') c = '#e67e22';
        Game.texts.push(new FloatText(this.x,this.y-20,Math.floor(v), c));
        
        if(type === 'water') this.slowTimer = 2.0; // å†°å†»å‡é€Ÿ

        if(this.hp<=0) {
            this.dead=true; Game.score++; Game.orbs.push(new Orb(this.x,this.y,this.exp)); Game.updateUI();
            if(type==='fire') Game.screenShake(0.5);
        }
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y);
        if(Game.player.x<this.x) ctx.scale(-1,1);
        ctx.drawImage(Assets[this.img], -24, -24, 48, 48);
        if(this.slowTimer>0) {
            ctx.globalCompositeOperation = 'source-atop';
            ctx.fillStyle = 'rgba(52, 152, 219, 0.5)';
            ctx.fillRect(-24,-24,48,48);
            ctx.globalCompositeOperation = 'source-over';
        }
        if(this.hp<this.maxHp) { ctx.fillStyle='red'; ctx.fillRect(-15,-30,30*(this.hp/this.maxHp),4); }
        ctx.restore();
    }
}

class Bullet extends Entity {
    constructor(x, y, t, s) {
        super(x, y);
        this.type = s.element; 
        const a = Math.atan2(t.y-y, t.x-x) + (Math.random()-0.5)*0.1;
        this.vx = Math.cos(a)*s.spd; this.vy = Math.sin(a)*s.spd;
        this.life = 2.0; this.dmg = s.dmg; this.angle = a;
        this.pierce = s.pierce || 0; // ç©¿é€æ¬¡æ•°
        this.hitList = []; 
        
        if(this.type === 'earth') { this.life = 3.0; this.dmg *= 1.5; }
    }
    update(dt) {
        this.life-=dt; if(this.life<=0) this.dead=true;
        this.x+=this.vx*dt; this.y+=this.vy*dt;
        
        if(this.type === 'fire') {
            if(Math.random()>0.2) Game.particles.push(new Particle(this.x,this.y,'#ff5722',0.5, 5));
        } else if (this.type === 'water') {
             if(Math.random()>0.5) Game.particles.push(new Particle(this.x,this.y,'#e1f5fe',0.3, 3));
        } else if (this.type === 'thunder') {
             // Keep compatible for fallback logic
             Game.particles.push(new Particle(this.x,this.y,'#fff',0.2, 2));
        } else {
            if(Math.random()>0.5) Game.particles.push(new Particle(this.x,this.y,'#00bcd4',0.3, 3));
        }

        for(let e of Game.enemies) {
            if(this.dist(e)<35 && !this.hitList.includes(e)) {
                this.hit(e);
                this.hitList.push(e);
                if(this.pierce > 0) {
                    this.pierce--;
                } else {
                    this.dead = true;
                    break;
                }
            }
        }
    }
    hit(e) {
        e.takeDamage(this.dmg, Math.cos(this.angle), Math.sin(this.angle), this.type);
        
        if(this.type === 'fire') {
            for(let i=0; i<10; i++) Game.particles.push(new Particle(this.x,this.y,'#ff9800', 0.6, 8));
        } else if(this.type === 'water') {
            for(let i=0; i<5; i++) Game.particles.push(new Particle(this.x,this.y,'#b3e5fc', 0.4, 5));
        } else if(this.type === 'earth') {
             Game.screenShake(0.2);
             for(let i=0; i<8; i++) Game.particles.push(new Particle(this.x,this.y,'#795548', 0.5, 6));
        } else {
            Game.particles.push(new Particle(this.x,this.y,'#fff',0.2, 6));
        }
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y);
        ctx.rotate(this.angle + Math.PI/2);
        if(this.type === 'fire') {
            ctx.rotate(Game.playTime * 10);
            ctx.drawImage(Assets['fire'], -16, -16, 32, 32);
        } else if(this.type === 'wood') {
             ctx.rotate(Game.playTime * 5);
             ctx.drawImage(Assets['leaf'], -12, -24, 24, 48);
        } else if(this.type === 'water') {
            ctx.drawImage(Assets['ice'], -16, -16, 32, 32);
        } else if(this.type === 'earth') {
            ctx.rotate(Game.playTime * 2);
            ctx.drawImage(Assets['rock_b'], -20, -20, 40, 40);
        } else {
            ctx.drawImage(Assets['sword'], -10, -20, 20, 40);
        }
        ctx.restore();
    }
}

class Lightning {
    constructor(x1, y1, x2, y2) {
        this.path = [];
        this.life = 0.2; 
        this.maxLife = 0.2;
        this.generate(x1, y1, x2, y2);
        this.dead = false;
    }
    generate(x1, y1, x2, y2) {
        const d = Math.hypot(x2-x1, y2-y1);
        const steps = Math.max(3, Math.floor(d / 20)); // æ¯20pxä¸€ä¸ªèŠ‚ç‚¹
        this.path.push({x:x1, y:y1});
        
        // è®¡ç®—æ³•å‘é‡
        const nx = -(y2-y1)/d;
        const ny = (x2-x1)/d;

        for(let i=1; i<steps; i++) {
            const t = i/steps;
            const jitter = (Math.random()-0.5) * 40; // æŠ–åŠ¨å¹…åº¦
            this.path.push({
                x: x1 + (x2-x1)*t + nx*jitter,
                y: y1 + (y2-y1)*t + ny*jitter
            });
        }
        this.path.push({x:x2, y:y2});
    }
    update(dt) {
        this.life -= dt;
        if(this.life <= 0) this.dead = true;
    }
    draw(ctx) {
        if(this.dead) return;
        const alpha = this.life / this.maxLife;
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // å¤–å‘å…‰
        ctx.shadowColor = '#bf55ec'; // ç´«è‰²è¾‰å…‰
        ctx.shadowBlur = 15;
        
        // æ ¸å¿ƒé—ªç”µ
        ctx.beginPath();
        ctx.moveTo(this.path[0].x, this.path[0].y);
        for(let i=1; i<this.path.length; i++) {
            ctx.lineTo(this.path[i].x, this.path[i].y);
        }
        
        // ç»˜åˆ¶ä¸¤å±‚ä»¥å¢å¼ºæ•ˆæœ
        ctx.strokeStyle = `rgba(255, 255, 255, ${alpha})`;
        ctx.lineWidth = 3;
        ctx.stroke();
        
        ctx.shadowBlur = 0;
        ctx.strokeStyle = `rgba(224, 176, 255, ${alpha})`; // æµ…ç´«
        ctx.lineWidth = 1.5;
        ctx.stroke();
        
        ctx.restore();
    }
}

class Particle {
    constructor(x,y,c,l,s) { 
        this.x=x; this.y=y; this.c=c; this.life=l; this.maxL=l; this.size=s; 
        const ang = Math.random()*Math.PI*2; const spd = Math.random()*100;
        this.vx=Math.cos(ang)*spd; this.vy=Math.sin(ang)*spd; 
    }
    update(dt) { this.life-=dt; if(this.life<=0) this.dead=true; this.x+=this.vx*dt; this.y+=this.vy*dt; }
    draw(ctx) { ctx.globalAlpha=this.life/this.maxL; ctx.fillStyle=this.c; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
}

class Orb extends Entity {
    constructor(x,y,v) { super(x,y); this.val=v; }
    update(dt,p) {
        const d=this.dist(p);
        if(d<p.stats.area) {
            const s=400+(500/(d+1)); const a=Math.atan2(p.y-this.y, p.x-this.x);
            this.x+=Math.cos(a)*s*dt; this.y+=Math.sin(a)*s*dt;
            if(d<20) { this.dead=true; p.gainExp(this.val); }
        }
    }
    draw(ctx) { ctx.save(); ctx.translate(this.x,this.y); const s=1+Math.sin(Game.playTime*10)*0.3; ctx.scale(s,s); ctx.fillStyle='#2ecc71'; ctx.beginPath(); ctx.arc(0,0,5,0,Math.PI*2); ctx.fill(); ctx.restore(); }
}

class FloatText extends Entity {
    constructor(x,y,t,c) { super(x,y); this.txt=t; this.c=c; this.life=0.8; }
    update(dt) { this.y-=50*dt; this.life-=dt; if(this.life<=0) this.dead=true; }
    draw(ctx) { ctx.globalAlpha=this.life; ctx.fillStyle=this.c; ctx.font="bold 24px Arial"; ctx.fillText(this.txt,this.x,this.y); ctx.globalAlpha=1; }
}

// --- 4. æŠ€èƒ½é…ç½® ---
const SKILLS = [
    { id:'sword_mult', name:'ä¸‡å‰‘å½’å®—', desc:'é£å‰‘æ•°é‡ +1', icon:'âš”ï¸', effect:s=>s.count++ },
    { id:'dmg', name:'å¤ªä¹™å‰‘æ°”', desc:'åŸºç¡€ä¼¤å®³ +20', icon:'ğŸ’ª', effect:s=>s.dmg+=20 },
    { id:'spd', name:'å¾¡å‰‘æœ¯', desc:'æ”»é€Ÿ +15%', icon:'ğŸŒªï¸', effect:s=>s.cd*=0.85 },
    // äº”è¡Œæµæ´¾
    { id:'fire', name:'çº¢è²ä¸šç«', desc:'<b>[ç«ç³»]</b> æ”»å‡»è½¬åŒ–ä¸ºçˆ†è£‚ç«çƒ', icon:'ğŸ”¥', rare:'fire', effect:s=>{s.element='fire'; s.dmg+=10; s.spd*=0.8;} },
    { id:'thunder', name:'ä¹å¤©ç¥é›·', desc:'<b>[é›·ç³»]</b> æ”»å‡»è½¬åŒ–ä¸ºæé€Ÿé—ªç”µ', icon:'âš¡', rare:'thunder', effect:s=>{s.element='thunder'; s.cd*=0.7; s.dmg*=0.8;} },
    { id:'wood', name:'é’å¸é•¿ç”Ÿ', desc:'<b>[æœ¨ç³»]</b> æ”»å‡»é™„å¸¦ç©¿é€æ•ˆæœ', icon:'ğŸƒ', rare:'wood', effect:s=>{s.element='wood'; s.pierce=3; s.dmg*=0.8;} },
    { id:'water', name:'ç„å†¥å¯’å†°', desc:'<b>[æ°´ç³»]</b> æ”»å‡»é€ æˆå¤§å¹…å‡é€Ÿ', icon:'â„ï¸', rare:'water', effect:s=>{s.element='water'; s.dmg*=0.9;} },
    { id:'earth', name:'åšåœŸæ³°å±±', desc:'<b>[åœŸç³»]</b> æ”»å‡»é™„å¸¦å·¨é¢å‡»é€€', icon:'â›°ï¸', rare:'earth', effect:s=>{s.element='earth'; s.dmg*=1.5; s.spd*=0.6;} }
];

const Game = new GameEngine();
function showUpgradeMenu() { 
    Game.pause(); const c=document.getElementById('card-container'); c.innerHTML=''; 
    document.getElementById('levelup-menu').classList.remove('hidden'); 
    const opts=SKILLS.sort(()=>Math.random()-0.5).slice(0,3); 
    opts.forEach(sk=>{ 
        const d=document.createElement('div'); d.className='card ' + (sk.rare?`rare-${sk.rare}`:''); 
        d.innerHTML=`<div class="card-icon">${sk.icon}</div><h3>${sk.name}</h3><p>${sk.desc}</p>`; 
        d.onclick=()=>{ sk.effect(Game.player.stats); document.getElementById('levelup-menu').classList.add('hidden'); Game.resume(); }; 
        c.appendChild(d); 
    }); 
}
</script>
</body>
</html>